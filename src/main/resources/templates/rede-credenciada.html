<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="pt-br" xmlns="http://www.w3.org/1999/xhtml">

<head>
    <meta charset="UTF-8">
    <!--<link href="http://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">-->
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <link rel="stylesheet" type="text/css" th:href="@{/css/bootstrap.min.css}"/>
    <link rel="stylesheet" type="text/css" th:href="@{/css/bootstrap-theme.min.css}"/>
    <link rel="stylesheet" type="text/css" th:href="@{/css/bootstrap.min.css}"/>
    <link rel="stylesheet" type="text/css" th:href="@{/css/main.css}"/>

    <script type="text/javascript" th:src="@{/js/jquery-3.2.1.min.js}"></script>
    <script type="text/javascript" th:src="@{/js/bootstrap.min.js}"></script>
    <script type="text/javascript" th:src="@{/js/jquery.mask.min.js}"></script>
    <script type="text/javascript" th:src="@{/js/odonto-Valida.js}"></script>
    <script type="text/javascript" th:src="@{/js/menu.js}"></script>
    <!--<script type="text/javascript" th:src="@{https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.12.9/umd/popper.min.js}"></script>-->

    <script>
        $(function () {
            $(".button-collapse").sideNav();
        });
    </script>

</head>

<body style="min-width: 100% !important;">

<div class="container-fluid nopadding">

    <div th:replace="fragments/menu-corretora :: ${session.usuario.perfil == 'Corretor'}  ? 'menu-corretor' : 'menu-corretora'">
        &nbsp;
    </div>

    <div th:replace="fragments/header-corretora :: ${session.usuario.perfil== 'Corretor'} ? 'header-corretor': 'header-corretora'">
        &nbsp;
    </div>


    <div class="container-logado padding-logado">

        <div class="row">
            <div class="col-xs-12">
                <h4 class="uppercase font-blue title-section-odonto pull-left">rede credenciada
                    <h4>
            </div>
        </div>

        <div class="row space-top-30">

            <div class="col-xs-12">

                <div class="form-group inline space-right width-form7">
                    <label class="label-cep uppercase">CEP</label>
                    <input type="text" id="cepRedeCredenciada" class="cep form-control">
                </div>
                <div class="form-group inline space-right width-form7">
                    <label class="label-cidade uppercase">Cidade</label>
                    <input type="text" id="cidade" class="cidade form-control">
                </div>
                <div class="form-group inline space-right width-form7">
                    <label class="label-bairro uppercase">Bairro </label>
                    <input type="text" id="bairro" class="bairro form-control">
                </div>

                <div class="form-group">
                    <label for="" class="label-especialidade labelOdontBlur">Especialidades</label>
                    <select class="form-control especialidade selectListBlur" id="especs">
                    </select>
                </div>

                <!--<div class="form-group inline width-form7">
                  <label class="">Especialidade</label>
                  <select class="form-control" id="">
                    <option>1</option>
                    <option>2</option>
                    <option>3</option>
                    <option>4</option>
                    <option>5</option>
                  </select>
              </div>-->

            </div>
        </div>


        <div class="row space-top-30">
            <div class="col-xs-12">

                <div class="w3-container r-medium">
                    <!--<button onclick="openModalRedeCredenciada()" class="w3-button w3-black">testeModal</button>-->
                    <div id="id01" class="w3-modal w3-animate-opacity" onclick="closeModalRedeCredenciada()">
                        <div class="w3-modal-content w3-card-4">
                            <header class="w3-container w3-teal"
                                    style="background-color: red; text-align: center; padding:20px;">
                                <!--   <span class="w3-button w3-large w3-display-topright">&times;</span>-->
                                <h3 id="nomeDentista"></h3>
                                <span class="r-light">CRO:</span> <span class="r-light" id="croDentista"></span>
                                <span class="r-light" id="tipoPessoaDentista"></span>
                                <!--<span class="r-light"> Pessoa física</span>-->
                            </header>
                            <div class="w3-container">
                                <p class="r-bold font-gray text-center space-top-30">Especialidades</p>

                                <div class="row space-top-30 text-center">
                                    <div class="col-xs-12">
                                        <img class="pull-center" src="../../img/Protese.png"><br>
                                        <span class="font-gray" id="especialidadeDentista1"></span>
                                    </div>
                                    <!--<div class="col-xs-3">
                                        <img class="pull-center" src="../../../assets/img/Ortodontia.png"><br>
                                        <span class="font-gray">Ortodontia</span>
                                    </div>
                                    <div class="col-xs-3">
                                        <img class="pull-center" src="../../../assets/img/Consulta.png"><br>
                                        <span class="font-gray">Consulta</span>
                                    </div>
                                    <div class="col-xs-3">
                                        <img class="pull-center" src="../../../assets/img/Cirurgia.png"><br>
                                        <span class="font-gray">Cirurgia</span>
                                    </div>-->
                                </div>


                                <div class="row space-top-60">
                                    <div class="col-xs-12 text-center">
                                        <p class="r-bold font-pink text-center">Endereço</p>
                                        <p class="r-light subtitle-odonto text-center" id="enderecoDentista"></p>
                                        <p class="r-light subtitle-odonto text-center">Cep: <span
                                                id="cepDentista"></span></p>
                                        <p class="r-light subtitle-odonto text-center" id="cidadeUF"></p>
                                    </div>
                                </div>

                                <div class="row space-top-20">
                                    <div class="col-xs-12 text-center">
                                        <p class="r-bold font-pink text-center">Contato</p>
                                        <p class="r-light subtitle-odonto text-center" id="telefoneDentista"></p>
                                        <!--<p class="r-light subtitle-odonto text-center">contato@doutora.com</p>-->
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!--<iframe src="https://www.google.com/maps/embed?pb=!1m10!1m8!1m3!1d29216.03390164659!2d-46.672658285746365!3d-23.747228293430716!3m2!1i1024!2i768!4f13.1!5e0!3m2!1spt-BR!2sbr!4v1518974180668" width="100%" height="600" frameborder="0" style="border:0" allowfullscreen ></iframe>-->

                <div id="map" class="nopadding" style="width:100%; height:600px">
                    <script async defer
                            src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBJVbswYP8yLVKCQGtTN3Xsifugqm8BBkQ&callback=mapa">

                    </script>
                </div>

                <script>
                    function initMap(redeCredenciada) {
                        var latlng = {lat: -23.5432147, lng: -46.7356894};
                        mapa(redeCredenciada);
                    }
                </script>


            </div>
        </div>

    </div>


    <div th:replace="fragments/footer :: footer">&nbsp;</div>


    <script type="text/javascript">
        var myMarkers = [];


        function openModalRedeCredenciada() {
            $("#id01").css("display", "block");
        }

        function closeModalRedeCredenciada() {
            $("#id01").css("display", "none");

        }

        function especialidades() {
            callToken(function (dataToken) {
                callEspecialidades(function (dataEspecialidades) {
                    //console.log(dataEspecialidades);

                    var sel = document.getElementById('especs');

                    for (var i = 0; i < dataEspecialidades.length; i++) {

                        var opt = document.createElement('option');
                        //console.log(dataEspecialidades[i].descricao);
                        opt.setAttribute('value', dataEspecialidades[i].codigo);
                        //console.log(dataEspecialidades[i].codigo);
                        opt.appendChild(document.createTextNode(dataEspecialidades[i].descricao));
                        sel.appendChild(opt);
                    }

                    //var especialidade = 1;
                    //document.getElementById('especs').value = especialidade;
                    //console.log(sel);

                }, dataToken.access_token);
            });
        }

        function mapa(abc) {

            /*var iconBase = '../../../assets/img/';
            var icons = {
                padrao: {
                icon: iconBase + 'pin_azul.png'
                },
                selecionado: {
                icon: iconBase + 'pin_rosa.png'
                }
            };*/


            var latlng = {lat: -23.5432147, lng: -46.7356894};
            var selectedMarker


            //initMap(latlng);

            if (abc == null) {
                var map = new google.maps.Map(document.getElementById('map'), {
                    zoom: 4,
                    center: latlng,
                    disableDefaultUI: true,
                });
            }
            else if (abc != null) {
                map = new google.maps.Map(document.getElementById('map'), {
                    zoom: 11,
                    center: {
                        lat: parseFloat(abc.dentistas[0].endereco.cidade.latitude),
                        lng: parseFloat(abc.dentistas[0].endereco.cidade.longitude)
                    },
                    disableDefaultUI: true,
                });

                for (var i = 0; i < abc.dentistas.length; i++) {
                    var latlng2 = new google.maps.LatLng((abc.dentistas[i].endereco.cidade.latitude), (abc.dentistas[i].endereco.cidade.longitude));


                    var marker = new google.maps.Marker({
                        position: latlng2,
                        map: map,
                        center: latlng2,
                        icon: '../../img/pin_azul.png'
                    });


                    var infowindow = new google.maps.InfoWindow();


                    google.maps.event.addListener(marker, 'click', (function (marker, i) {
                        return function () {
                            if (selectedMarker) {
                                selectedMarker.setIcon('../../img/pin_azul.png');
                            }
                            marker.setIcon('../../img/pin_rosa.png');
                            selectedMarker = marker;


                            //console.log("Dentro da funcão Click:  " + contentString[i]);
                            //infowindow.setContent('<div><strong>' + abc.dentistas[i].nomeDentista +'</strong><br>');
                            //infowindow.open(map, marker);

                            document.getElementById('nomeDentista').innerHTML = abc.dentistas[i].nomeDentista;
                            document.getElementById('croDentista').innerHTML = abc.dentistas[i].numeroCRO;
                            document.getElementById('especialidadeDentista1').innerHTML = abc.dentistas[i].especialidade.descricaoEspecialidade;
                            //document.getElementById('especialidadeDentista1').innerHTML=abc.dentistas[i].especialidade.descricaoEspecialidade;
                            document.getElementById('enderecoDentista').innerHTML = abc.dentistas[i].endereco.enderecoCompleto;
                            document.getElementById('cepDentista').innerHTML = abc.dentistas[i].endereco.cep;
                            document.getElementById('telefoneDentista').innerHTML = abc.dentistas[i].numeroFone;
                            document.getElementById('tipoPessoaDentista').innerHTML = abc.dentistas[i].tipoPrestador;
                            document.getElementById('cidadeUF').innerHTML = abc.dentistas[i].endereco.cidade.nome + "," + abc.dentistas[i].endereco.cidade.siglaUF;

                            //$("#btnModal").click();


                            //console.log(abc.dentistas[i].especialidade.descricaoEspecialidade);

                            openModalRedeCredenciada()

                        }
                    })(marker, i));

                }
            }
        }

        var t;

        function callToken(callback) {

            $.ajax({
                async: true,
                url: "https://api.odontoprev.com.br:8243/token/",
                method: "POST",
                headers: {
                    "Authorization": "Basic Y3hHZXBoTzFkcERDd3U0VHlfRExWTWxXQ0R3YTp0WlJtSUN1eUJWajJZRVczRjdaNXdWM2E0YVlh",
                    "Cache-Control": "no-cache",
                    "Content-Type": "application/x-www-form-urlencoded"
                },
                data: {
                    "grant_type": "client_credentials"
                },
                success: function (resp) {
                    callback(resp)
                },
            });
        }

        function callCep(callback, token, cep) {


            $.ajax({
                async: true,
                url: "https://api.odontoprev.com.br:8243/cep/1.1/por/cep/" + cep,
                method: "GET",
                headers: {
                    "Authorization": "Bearer " + token,
                    "Cache-Control": "no-cache",
                    "Content-Type": "application/json"
                },
                success: function (resp) {
                    callback(resp)
                },

                error: function (xhr) {
                    if (xhr.status == 500) {
                        console.log("CEP INVALIDO");
                        //document.getElementById('labelCep').style.display = 'block';
                        //document.getElementById('labelCep').innerHTML="CEP não foi encontrado";
                    }
                }
            });
        }

        function callEspecialidades(callback, token) {


            $.ajax({
                async: true,
                url: "https://api.odontoprev.com.br:8243/redecredenciada/1.0/especialidades",
                method: "GET",
                headers: {
                    "Authorization": "Bearer " + token,
                    "Cache-Control": "no-cache",
                    "Content-Type": "application/json"
                },
                success: function (resp) {
                    callback(resp)
                },
            });
        }

        function callCidade(callback, token, uf, codigoCidade) {

            $.ajax({
                async: true,
                url: "https://api.odontoprev.com.br:8243/cep/1.1/cidades/uf?uf=" + uf + "&codigoCidade=" + codigoCidade,
                method: "GET",
                headers: {
                    "Authorization": "Bearer " + token,
                    "Cache-Control": "no-cache",
                    "Content-Type": "application/json"
                },
                success: function (resp) {
                    callback(resp)
                },
            });
        }

        function callBairro(callback, token, uf, codigoCidade, codigoBeneficiario) {

            $.ajax({
                async: true,
                url: "https://api.odontoprev.com.br:8243/cep/1.1/bairros?uf=" + uf + "&codigoCidade=" + codigoCidade + "&codigoBeneficiario=" + codigoBeneficiario,
                method: "GET",
                headers: {
                    "Content-Type": "application/json",
                    "Authorization": "Bearer " + token,
                    "Cache-Control": "no-cache",
                    "Postman-Token": "c7575dd9-1908-dcf4-12eb-9091693dd541"

                },
                success: function (resp) {
                    callback(resp)
                },
                error: function (xhr) {
                }
            });
        }

        function callRedeCredenciada(callback, token, CodBeneficiario, uf, codigoEspecialidade, codigoMicroregiao, privian, codigoMarca, codigoBairro) {


            $.ajax({
                async: true,
                url: "https://api.odontoprev.com.br:8243/dcms/redecredenciada/1.0/dentistas?codigoBeneficiario=" + CodBeneficiario
                + "&siglaUf=" + uf + "&codigoEspecialidade=" + codigoEspecialidade + "&codigoRegiao=" + codigoMicroregiao + "&privian=" + privian + "&codigoMarca=" +
                codigoMarca + "&codigoBairro=" + codigoBairro,
                //url: "https://api.odontoprev.com.br:8243/cep/1.1/bairros?uf=" + uf + "&codigoCidade=" + codigoCidade + "&codigoBeneficiario=" + codigoBeneficiario,
                method: "GET",
                headers: {
                    "Content-Type": "application/json",
                    "Authorization": "Bearer " + token,
                    "Cache-Control": "no-cache"
                },

                success: function (resp) {
                    callback(resp)

                },
                error: function (xhr) {
                }
            });
        }


        function removerAcentos(newStringComAcento) {
            var string = newStringComAcento;
            var mapaAcentosHex = {
                a: /[\xE0-\xE6]/g,
                e: /[\xE8-\xEB]/g,
                i: /[\xEC-\xEF]/g,
                o: /[\xF2-\xF6]/g,
                u: /[\xF9-\xFC]/g,
                c: /\xE7/g,
                n: /\xF1/g
            };

            for (var letra in mapaAcentosHex) {
                var expressaoRegular = mapaAcentosHex[letra];
                string = string.replace(expressaoRegular, letra);
            }

            return string;
        }


        $(document).ready(function () {
            var t1;


            //$("#btnTeste").click(function (e) {
            $("#cepRedeCredenciada").keyup(function () {

                var cep = $('#cepRedeCredenciada').val().replace(/\D/g, '');

                if (cep != "" && cep.length == 8) {


                    var cep = $("#cepRedeCredenciada").val().replace(/\D/g, '');

                    callToken(function (dataToken) {
                        t1 = dataToken;

                        callCep(function (dataCep) {
                            var teste = removerAcentos(dataCep[0].cidade);
                            teste = teste.toUpperCase();

                            console.log("CEP: " + dataCep[0].cidade);


                            callCidade(function (dataCidade) {
                                var result = $.grep(dataCidade, function (e) {
                                    return e.nome == removerAcentos(dataCep[0].cidade).toUpperCase();
                                });

                                var CodBeneficiario = "375796040";


                                callBairro(function (dataBairro) {


                                    var codigoEspecialidade = $('#especs').val();
                                    //var codigoEspecialidade = "1";
                                    var privian = "FALSE";
                                    var codigoMarca = "1";

                                    //var bairro = dataCep[0].bairro.toUpperCase();

                                    var codigoBairro = $.grep(dataBairro, function (e) {
                                        if (dataCep[0].bairro != null) {
                                            return e.nome == dataCep[0].bairro.toUpperCase()
                                        } else {
                                            return e.nome == dataCep[0].cidade.toUpperCase()
                                        }

                                    });

                                    if (codigoBairro == null) {
                                        codigoBairro = "";
                                    }

                                    //console.log(codigoBairro);
                                    //console.log(result[0].codigoMicroregiao);


                                    if (codigoBairro.length == 0) {
                                        callRedeCredenciada(function (dataRedeCredenciada) {
                                            //console.log(dataRedeCredenciada);
                                            initMap(dataRedeCredenciada);

                                        }, dataToken.access_token, CodBeneficiario, dataCep[0].estado, codigoEspecialidade, result[0].codigoMicroregiao, privian, codigoMarca, "0");

                                    }
                                    else if (codigoBairro != null) {
                                        callRedeCredenciada(function (dataRedeCredenciada) {
                                            initMap(dataRedeCredenciada);
                                        }, dataToken.access_token, CodBeneficiario, dataCep[0].estado, codigoEspecialidade, result[0].codigoMicroregiao, privian, codigoMarca, codigoBairro[0].codigo);
                                    }

                                }, dataToken.access_token, dataCep[0].estado, result[0].codigoCidade, CodBeneficiario);

                            }, dataToken.access_token, dataCep[0].estado, dataCep[0].idCidade);

                        }, dataToken.access_token, cep);

                    });

                }

            });
        });

        //$(document).ready(function() {
        $("#cepRedeCredenciada").keyup(function () {
            //alert( "Digitando CEP" );


            function limpa_formulário_cep() {
                // Limpa valores do formulário de cep.
                $("#bairro").val("");
                $("#cidade").val("");
            }

            var typingTimer; //timer identifier
            var doneTypingInterval = 500; //time in ms, 5 second for example

            //on keyup, start the countdown
            $('#cepRedeCredenciada').keyup(function () {
                clearTimeout(typingTimer);
                if ($('#cepRedeCredenciada').val) {
                    typingTimer = setTimeout(doneTyping, doneTypingInterval);
                }
            });

            function doneTyping() {
                validar();
            }

            function validar() {
                //Nova variável "cep" somente com dígitos.
                var CepExibir = $('#cepRedeCredenciada').val()
                var cep = $('#cepRedeCredenciada').val().replace(/\D/g, '');

                //Verifica se campo cep possui valor informado.
                if (cep != "" && cep.length == 8) {

                    //Expressão regular para validar o CEP.
                    var validacep = /^[0-9]{8}$/;

                    //Valida o formato do CEP.
                    if (validacep.test(cep)) {

                        //Preenche os campos com "..." enquanto consulta webservice.
                        $("#bairro").val("");
                        $("#cidade").val("");

                        $("#cepRedeCredenciada").val(CepExibir);
                        callToken(function (dataToken) {
                            callCep(function (dataCep) {
                                $("#cepRedeCredenciada").val(CepExibir);
                                $("#bairro").val(dataCep[0].bairro);
                                $("#cidade").val(dataCep[0].cidade);

                            }, dataToken.access_token, cep);
                        });

                        //    //Consulta o webservice viacep.com.br/
                        //    $.getJSON("https://viacep.com.br/ws/"+ cep +"/json/?callback=?", function(dados)
                        //    {
                        //        if (!("erro" in dados)) {
                        //        //Atualiza os campos com os valores da consulta.
                        //            $("#rua").val(dados.logradouro);
                        //            $("#bairro").val(dados.bairro);
                        //            $("#cidade").val(dados.localidade);
                        //            $("#uf").val(dados.uf);
                        //        } //end if.
                        //        else {
                        //            //CEP pesquisado não foi encontrado.
                        //            limpa_formulário_cep();
                        //            alert("CEP não encontrado.");
                        //        }
                        //    });


                    } //end if.
                    else {
                        //cep é inválido.
                        limpa_formulário_cep();
                        alert("Formato de CEP inválido.");
                    }
                } //end if.
                else {
                    //cep sem valor, limpa formulário.
                    limpa_formulário_cep();
                }
            }

            //Quando o campo cep perde o foco.

        });
    </script>


</body>

</html>